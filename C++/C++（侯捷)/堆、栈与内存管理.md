# Stack

每当调用函数时，函数本身会形成一个stack，用于存放：

- 接收参数
- 返回地址
- 函数体内声明的任何变量（包含local object）



# Heap

或称system heap，是指由操作系统提供的一块global内存空间，程序可对其进行动态分配。



# stack objects的生命期

![image-20220707124210013](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707124210013.png)

- c1即为所谓的stack object，其生命在作用域结束后而结束。
- 这种作用域内的object，又称为 auto object，因为它会被自动清理。



# static local objects的生命期

![image-20220707124328116](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707124328116.png)

- c2即为所谓的static object，其生命周期在作用域结束后仍存在，直至整个程序结束



# global objects的生命期

![image-20220707124500301](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707124500301.png)

- c3即为所谓的global object，其生命在整个程序结束后结束。



# heap objects的生命期

![image-20220707124726125](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707124726125.png)

- p所指的便是heap object，其生命在被deleted后才结束



# new：先分配memory,再调用ctor

![image-20220707124942379](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707124942379.png)



# delete：先待用dtor,再释放memory

![image-20220707125011785](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707125011785.png)



# 动态分配所得的内存块 in VC

![image-20220707133448107](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707133448107.png)

> 注意:
>
> - 分配的内存块，都是16字节的倍数
>
> - **调试模式下：需要额外分配 32 + 4 字节**
>
> - 内存卡的两侧，各需要一个Cookie（一个4字节），记录此块的大小
>
>   > 例如，64个字节即0x40，最后一位标记为1，表示未释放
>
> > 上图中，每个格的大小，均为4B



## 动态分配所得的array in VC

![image-20220707133916850](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707133916850.png)

以调试模式为例，分配长度为3的complex数组，需要：

(4+4)\*3 + 32+4 + 4\* 2 + 4，其中最后4个字节，用于表示该数组的长度



> #### 💡 **array new 一定要搭配 array delete**

![image-20220707140127801](%E5%A0%86%E3%80%81%E6%A0%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.assets/image-20220707140127801.png)



> 事实上，如果某个类没有调用析构函数的必要，使用delete也ok，但不推荐。